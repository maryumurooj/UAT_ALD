import { getFirestore, doc, getDoc, updateDoc, query, collection, where, getDocs } from "firebase/firestore";
import { getAuth, onAuthStateChanged } from "firebase/auth";

// Initialize Firestore and Auth
const db = getFirestore();
const auth = getAuth();

const checkSubscriptionStatus = async () => {
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    try {
      // Query the subscriptions collection for active subscription
      const subscriptionQuery = query(
        collection(db, "subscriptions"),
        where("uid", "==", user.uid),
        where("subscriptionStatus", "==", "active")
      );
      const subscriptionSnapshot = await getDocs(subscriptionQuery);

      if (subscriptionSnapshot.empty) {
        console.log("No active subscription found for this user.");
        return;
      }

      const subscriptionDoc = subscriptionSnapshot.docs[0];
      const subscriptionData = subscriptionDoc.data();
      const subscriptionRef = subscriptionDoc.ref;

      const now = new Date();
      const endingDate = new Date(subscriptionData.endingDate);

      if (isNaN(endingDate.getTime())) {
        throw new Error("Invalid endingDate in subscription.");
      }

      if (endingDate < now) {
        console.log("âŒ Subscription expired. Updating Firestore...");

        // 1. Update subscription status
        await updateDoc(subscriptionRef, { subscriptionStatus: "expired" });

        // 2. Update user document
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, { subscriptionStatus: "expired" });

        // 3. Update billingAddress document where uid == user.uid
        const billingQuery = query(
          collection(db, "billingAddress"),
          where("uid", "==", user.uid)
        );
        const billingSnapshot = await getDocs(billingQuery);

        if (!billingSnapshot.empty) {
          const billingRef = billingSnapshot.docs[0].ref;
          await updateDoc(billingRef, { paymentMethod: "expired" });
          console.log("ðŸ“¦ Billing address payment method set to 'expired'.");
        } else {
          console.log("No billingAddress document found for this user.");
        }

        console.log("âœ” Subscription and related documents updated to 'expired'.");
      } else {
        const daysLeft = Math.ceil((endingDate - now) / (1000 * 60 * 60 * 24));
        console.log(`âœ… Subscription is still active. Days remaining: ${daysLeft}`);
      }

    } catch (error) {
      console.error("Error checking subscription:", error);
    }
  });
};

export default checkSubscriptionStatus;
